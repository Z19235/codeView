<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨èƒ½æ’åºç®—æ³•æ•™å­¦å¹³å° V2.0</title>
    <style>
        :root {
            --primary: #3b82f6;
            --compare: #f59e0b;
            --swap: #ef4444;
            --sorted: #10b981;
            --pivot: #8b5cf6;
            --aux: #64748b;
            --bg: #f1f5f9;
            --text: #334155;
            --code-bg: #1e1e1e;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            box-sizing: border-box;
        }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        header {
            width: 100%;
            max-width: 1400px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: white;
            padding: 12px 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        h1 { margin: 0; font-size: 1.4rem; color: #1e293b; display: flex; align-items: center; gap: 10px; }

        .controls { display: flex; gap: 15px; align-items: center; }

        select, button, input {
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button { background: var(--primary); color: white; border: none; font-weight: 600; }
        button:hover { background: #2563eb; transform: translateY(-1px); }
        button:disabled { background: #94a3b8; cursor: not-allowed; transform: none; }
        button.btn-reset { background: #64748b; }

        /* æ ¸å¿ƒå¯è§†åŒ–åŒºåŸŸ */
        .viz-container {
            flex: 1;
            width: 100%;
            max-width: 1400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding: 20px 20px 50px 20px;
            overflow: hidden;
            margin-bottom: 15px;
            min-height: 250px;
        }

        .bar {
            width: 25px; /* ç¨å¾®è°ƒçª„ä¸€ç‚¹ä»¥é€‚åº”æ›´å¤šæ¡ç›® */
            margin: 0 3px;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            transition: height 0.2s ease, background-color 0.2s;
            position: relative;
            display: flex;
            justify-content: center;
        }

        .bar-val {
            margin-top: 5px;
            font-size: 11px;
            color: rgba(255,255,255,0.9);
            font-weight: bold;
        }

        /* æŒ‡é’ˆæ ·å¼ */
        .pointer {
            position: absolute;
            bottom: -35px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: left 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 10;
            width: 25px;
        }

        .pointer-arrow {
            width: 0; height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 7px solid;
        }
        .pointer-label { font-size: 13px; font-weight: bold; margin-top: 2px; }

        /* åº•éƒ¨ä¸‰æ å¸ƒå±€ */
        .bottom-panel {
            width: 100%;
            max-width: 1400px;
            height: 300px; /* å›ºå®šé«˜åº¦ */
            display: grid;
            grid-template-columns: 20% 55% 25%; /* çŸ¥è¯†:ä»£ç :æ—¥å¿— */
            gap: 15px;
        }

        .panel-box {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* 1. çŸ¥è¯†å¡ç‰‡ */
        .knowledge-card h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #f1f5f9; padding-bottom: 4px; font-size: 0.9rem;}
        .stat-val { font-weight: bold; font-family: monospace; }
        .desc-text { font-size: 13px; color: #64748b; line-height: 1.5; flex: 1; overflow-y: auto; }

        /* 2. ä»£ç ç¼–è¾‘å™¨é£æ ¼ */
        .code-container {
            background: var(--code-bg);
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            position: relative;
            padding: 0;
        }
        .code-header {
            background: #2d2d2d;
            padding: 5px 15px;
            color: #aaa;
            font-size: 12px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
        }
        .code-content {
            padding: 15px;
            overflow: auto;
            height: 100%;
            white-space: pre;
            line-height: 1.4;
        }

        /* ç®€å•çš„è¯­æ³•é«˜äº®é¢œè‰² */
        .kw { color: #569cd6; font-weight: bold; } /* keyword */
        .type { color: #4ec9b0; } /* class/type */
        .fn { color: #dcdcaa; } /* function */
        .num { color: #b5cea8; } /* number */
        .str { color: #ce9178; } /* string */
        .cmt { color: #6a9955; font-style: italic; } /* comment */

        /* 3. æ—¥å¿—åŒºåŸŸ */
        .log-box {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }

        .badge {
            display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 5px;
        }
        .bg-swap { background: var(--swap); color: white; }
        .bg-cmp { background: var(--compare); color: white; }

    </style>
</head>
<body>
<div id="global-back-btn" style="position: fixed; top: 15px; left: 15px; z-index: 9999; cursor: pointer; background: white; padding: 8px 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 6px; font-family: 'Segoe UI', sans-serif; border: 1px solid #e2e8f0; transition: all 0.2s; user-select: none;">
    <span style="font-size: 16px;">ğŸ”™</span>
    <span style="font-weight: 600; font-size: 14px; color: #334155;">è¿”å›ç›®å½•</span>
</div>
<header>
    <h1>ğŸ§ª ç®—æ³•å®éªŒå®¤ <span style="font-size:14px; color:#64748b; font-weight:normal; margin-left:10px;">Visualizer + Java Code</span></h1>
    <div class="controls">
        <select id="algo-select" onchange="visualizer.handleAlgoChange()">
            <option value="bubble">å†’æ³¡æ’åº (Bubble Sort)</option>
            <option value="selection">é€‰æ‹©æ’åº (Selection Sort)</option>
            <option value="insertion">æ’å…¥æ’åº (Insertion Sort)</option>
            <option value="quick">å¿«é€Ÿæ’åº (Quick Sort)</option>
            <option value="merge">å½’å¹¶æ’åº (Merge Sort)</option>
        </select>
        <div style="display:flex; align-items:center; gap:5px; font-size:12px; color:#666;">
            <span>é€Ÿåº¦:</span>
            <input type="range" id="speed-range" min="1" max="50" value="25">
        </div>
        <button class="btn-reset" onclick="visualizer.reset()">é‡ç½®æ•°ç»„</button>
        <button id="btn-start" onclick="visualizer.start()">â–¶ å¼€å§‹æ’åº</button>
    </div>
</header>

<div class="viz-container" id="container"></div>

<div class="bottom-panel">

    <div class="panel-box knowledge-card" id="knowledge-box">
    </div>

    <div class="panel-box code-container">
        <div class="code-header">
            <span>JAVA IMPLEMENTATION</span>
            <span id="code-filename">BubbleSort.java</span>
        </div>
        <div class="code-content" id="code-view">
        </div>
    </div>

    <div class="panel-box log-box" id="log-box">
        <div class="log-line">>> ç³»ç»Ÿå°±ç»ª...</div>
    </div>
</div>

<script>
    // ================= 1. æ•°æ®èµ„æº (Info & Code) =================
    const ALGO_DATA = {
        bubble: {
            name: "å†’æ³¡æ’åº",
            desc: "å°±åƒæ°”æ³¡ä¸Šæµ®ä¸€æ ·ï¼Œæ¯æ¬¡æ¯”è¾ƒç›¸é‚»ä¸¤ä¸ªå…ƒç´ ï¼Œå¦‚æœé¡ºåºé”™è¯¯å°±äº¤æ¢ã€‚æ¯ä¸€è½®å¾ªç¯ç»“æŸåï¼Œæœ€å¤§çš„å…ƒç´ éƒ½ä¼š'æµ®'åˆ°æ•°ç»„æœ«ç«¯ã€‚",
            time: "O(nÂ²)", space: "O(1)", stable: "ç¨³å®š",
            code: `public static void bubbleSort(int[] arr) {
    int n = arr.length;
    // å¤–å±‚å¾ªç¯ï¼šæ§åˆ¶æ¯”è¾ƒè½®æ•°
    for (int i = 0; i < n - 1; i++) {
        boolean swapped = false;
        // å†…å±‚å¾ªç¯ï¼šä¸¤ä¸¤æ¯”è¾ƒ
        for (int j = 0; j < n - 1 - i; j++) {
            if (arr[j] > arr[j + 1]) {
                swap(arr, j, j + 1);
                swapped = true;
            }
        }
        if (!swapped) break; // ä¼˜åŒ–ï¼šæ— äº¤æ¢åˆ™æå‰ç»“æŸ
    }
}`
        },
        selection: {
            name: "é€‰æ‹©æ’åº",
            desc: "ç®€å•ç²—æš´ã€‚æŠŠæ•°ç»„åˆ†ä¸º'å·²æ’åº'å’Œ'æœªæ’åº'ä¸¤éƒ¨åˆ†ã€‚æ¯æ¬¡ä»æœªæ’åºéƒ¨åˆ†æ‰«ææ‰¾åˆ°æœ€å°çš„æ•°ï¼ŒæŠŠå®ƒæ”¾åˆ°å·²æ’åºéƒ¨åˆ†çš„æœ«å°¾ã€‚",
            time: "O(nÂ²)", space: "O(1)", stable: "ä¸ç¨³å®š",
            code: `public static void selectionSort(int[] arr) {
    int n = arr.length;
    for (int i = 0; i < n - 1; i++) {
        int minIndex = i;
        // å¯»æ‰¾æœªæ’åºåŒºé—´çš„æœ€å°å€¼
        for (int j = i + 1; j < n; j++) {
            if (arr[j] < arr[minIndex]) {
                minIndex = j;
            }
        }
        // å°†æœ€å°å€¼äº¤æ¢åˆ°å½“å‰ä½ç½® i
        if (minIndex != i) {
            swap(arr, i, minIndex);
        }
    }
}`
        },
        insertion: {
            name: "æ’å…¥æ’åº",
            desc: "åƒæ‰“æ‰‘å…‹ç†ç‰Œä¸€æ ·ã€‚æ‰‹é‡Œæ¡ç€å·²æ’åºçš„ç‰Œï¼Œæ‘¸ä¸€å¼ æ–°ç‰Œï¼Œä»åå¾€å‰æ‰«æï¼Œæ‰¾åˆ°æ­£ç¡®ä½ç½®æ’è¿›å»ã€‚",
            time: "O(nÂ²)", space: "O(1)", stable: "ç¨³å®š",
            code: `public static void insertionSort(int[] arr) {
    int n = arr.length;
    // ä»ç¬¬äºŒä¸ªå…ƒç´ å¼€å§‹
    for (int i = 1; i < n; i++) {
        int key = arr[i];
        int j = i - 1;
        // å°†å¤§äº key çš„å…ƒç´ åç§»
        while (j >= 0 && arr[j] > key) {
            arr[j + 1] = arr[j];
            j--;
        }
        arr[j + 1] = key; // æ’å…¥
    }
}`
        },
        quick: {
            name: "å¿«é€Ÿæ’åº",
            desc: "åˆ†æ²»æ³•ä¹‹ç‹ã€‚éšä¾¿é€‰ä¸ª'åŸºå‡†(Pivot)'ï¼Œæ¯”å®ƒå°çš„æ‰”å·¦è¾¹ï¼Œæ¯”å®ƒå¤§çš„æ‰”å³è¾¹ã€‚ç„¶åå¯¹å·¦å³ä¸¤è¾¹åˆ†åˆ«é‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚",
            time: "O(n log n)", space: "O(log n)", stable: "ä¸ç¨³å®š",
            code: `public static void quickSort(int[] arr, int low, int high) {
    if (low < high) {
        // åˆ†åŒºæ“ä½œï¼Œè¿”å›åŸºå‡†ç´¢å¼•
        int pi = partition(arr, low, high);

        quickSort(arr, low, pi - 1);  // é€’å½’å·¦ä¾§
        quickSort(arr, pi + 1, high); // é€’å½’å³ä¾§
    }
}

private static int partition(int[] arr, int low, int high) {
    int pivot = arr[high]; // é€‰æœ€å³ä¸ºåŸºå‡†
    int i = (low - 1);

    for (int j = low; j < high; j++) {
        if (arr[j] < pivot) {
            i++;
            swap(arr, i, j);
        }
    }
    swap(arr, i + 1, high);
    return i + 1;
}`
        },
        merge: {
            name: "å½’å¹¶æ’åº",
            desc: "å…¸å‹çš„åˆ†æ²»ã€‚å…ˆ'åˆ†'ï¼šæŠŠæ•°ç»„ä¸€åˆ†ä¸ºäºŒï¼Œç›´åˆ°åˆ‡æˆå•ä¸ªå…ƒç´ ï¼›å†'æ²»'ï¼šæŠŠä¸¤ä¸ªæœ‰åºå°æ•°ç»„åˆå¹¶æˆä¸€ä¸ªå¤§æ•°ç»„ã€‚",
            time: "O(n log n)", space: "O(n)", stable: "ç¨³å®š",
            code: `public static void mergeSort(int[] arr, int left, int right) {
    if (left < right) {
        int mid = left + (right - left) / 2;
        mergeSort(arr, left, mid);
        mergeSort(arr, mid + 1, right);
        merge(arr, left, mid, right);
    }
}

// åˆå¹¶é€»è¾‘ (ç®€åŒ–ç¤ºæ„)
private static void merge(int[] arr, int l, int m, int r) {
    // 1. åˆ›å»ºä¸´æ—¶æ•°ç»„ L[] å’Œ R[] æ‹·è´æ•°æ®
    // 2. æ¯”è¾ƒ L å’Œ R çš„å…ƒç´ ï¼Œè°å°å–è°æ”¾å…¥ arr[k]
    // 3. æ‹·è´å‰©ä½™å…ƒç´ 
}`
        }
    };

    // ================= 2. å¯è§†åŒ–æ§åˆ¶å™¨ =================
    class SortVisualizer {
        constructor() {
            this.container = document.getElementById('container');
            this.logBox = document.getElementById('log-box');
            this.knowledgeBox = document.getElementById('knowledge-box');
            this.codeView = document.getElementById('code-view');

            this.array = [];
            this.bars = [];
            this.size = 30; // å¢åŠ æ¡ç›®æ•°é‡
            this.speed = 100;
            this.abort = false;
            this.isSorting = false;

            document.getElementById('speed-range').addEventListener('input', (e) => {
                this.speed = 520 - (e.target.value * 10);
            });

            this.reset();
        }

        reset() {
            this.abort = true;
            this.isSorting = false;
            document.getElementById('btn-start').disabled = false;
            this.clearPointers();
            this.generateArray();
            this.render();
            this.handleAlgoChange(); // æ›´æ–°UIä¿¡æ¯
            this.log("æ•°ç»„å·²é‡ç½®");
        }

        handleAlgoChange() {
            const algoKey = document.getElementById('algo-select').value;
            const data = ALGO_DATA[algoKey];

            // 1. æ›´æ–°çŸ¥è¯†å¡ç‰‡
            this.knowledgeBox.innerHTML = `
                <h3>${data.name}</h3>
                <div class="stat-row"><span style="color:#666">æ—¶é—´</span> <span class="stat-val" style="color:var(--compare)">${data.time}</span></div>
                <div class="stat-row"><span style="color:#666">ç©ºé—´</span> <span class="stat-val">${data.space}</span></div>
                <div class="stat-row"><span style="color:#666">ç‰¹æ€§</span> <span class="stat-val">${data.stable}</span></div>
                <div class="desc-text">${data.desc}</div>
            `;

            // 2. æ›´æ–°ä»£ç å¹¶é«˜äº®
            document.getElementById('code-filename').innerText = algoKey.charAt(0).toUpperCase() + algoKey.slice(1) + "Sort.java";
            this.codeView.innerHTML = this.highlightJava(data.code);
        }

        // ç®€å•çš„ Java è¯­æ³•é«˜äº®å™¨
        highlightJava(code) {
            code = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");

            // é¡ºåºå¾ˆé‡è¦ï¼šå…ˆæ³¨é‡Šï¼Œå†å­—ç¬¦ä¸²ï¼Œå†å…³é”®å­—
            // ç®€åŒ–ç‰ˆæ­£åˆ™ï¼Œå¹¶ä¸å®Œç¾ä½†è¶³å¤Ÿæ•™å­¦æ¼”ç¤º
            const rules = [
                { regex: /(\/\/.*)/g, cls: 'cmt' }, // å•è¡Œæ³¨é‡Š
                { regex: /\b(public|private|static|void|int|boolean|if|else|for|while|return|break|new)\b/g, cls: 'kw' },
                { regex: /\b(swap|partition|merge|length)\b/g, cls: 'fn' }, // å¸¸ç”¨å‡½æ•°/å±æ€§
                { regex: /\b(\d+)\b/g, cls: 'num' },
            ];

            // è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æ›¿æ¢é€»è¾‘ï¼Œå®é™…é«˜äº®é€šå¸¸éœ€è¦ Parser
            // è¿™é‡Œä¸ºäº†ä¿æŒå•æ–‡ä»¶ç®€æ´ï¼Œé‡‡ç”¨å¤šæ¬¡æ›¿æ¢ï¼Œå­˜åœ¨ä¸€å®šç¼ºé™·(å¦‚å­—ç¬¦ä¸²å†…å…³é”®å­—)ä½†å¯æ¥å—

            // ä¸ºäº†é˜²æ­¢æ ‡ç­¾å†…çš„classè¢«å†æ¬¡æ›¿æ¢ï¼Œæˆ‘ä»¬å…ˆæ‹†åˆ† tokens (è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥æ›¿æ¢å…³é”®å­—)
            // æ›´å¥½çš„æ–¹å¼æ˜¯éå†å­—ç¬¦ï¼Œä½†è¿™é‡Œæˆ‘ä»¬åªåšæ ¸å¿ƒé«˜äº®

            let html = code;
            rules.forEach(rule => {
                // ä½¿ç”¨å ä½ç¬¦é˜²æ­¢é‡å¤æ›¿æ¢ï¼Œè¿™é‡Œç®€åŒ–ï¼Œç›´æ¥ä¾é æ­£åˆ™è¾¹ç•Œ
                html = html.replace(rule.regex, '<span class="'+rule.cls+'">$1</span>');
            });
            return html;
        }

        generateArray() {
            this.array = [];
            for (let i = 0; i < this.size; i++) {
                this.array.push(Math.floor(Math.random() * 85) + 10);
            }
        }

        render() {
            this.container.innerHTML = '';
            this.bars = [];
            this.array.forEach((val, idx) => {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${val * 2.5}px`;
                bar.innerHTML = `<span class="bar-val">${val}</span>`;
                this.container.appendChild(bar);
                this.bars.push(bar);
            });
        }

        log(msg, type='info') {
            const line = document.createElement('div');
            line.className = 'log-line';

            let badge = '';
            if(type === 'swap') badge = '<span class="badge bg-swap">SWAP</span>';
            if(type === 'cmp') badge = '<span class="badge bg-cmp">CMP</span>';

            line.innerHTML = `${badge}${msg}`;
            this.logBox.insertBefore(line, this.logBox.firstChild);
        }

        async sleep() {
            return new Promise(resolve => setTimeout(resolve, this.speed));
        }

        setColor(indices, type) {
            if (!Array.isArray(indices)) indices = [indices];
            indices.forEach(idx => {
                if(this.bars[idx]) {
                    const colorMap = {
                        'default': 'var(--primary)', 'compare': 'var(--compare)',
                        'swap': 'var(--swap)', 'sorted': 'var(--sorted)',
                        'pivot': 'var(--pivot)', 'aux': 'var(--aux)'
                    };
                    this.bars[idx].style.backgroundColor = colorMap[type];
                }
            });
        }

        async swap(i, j) {
            if(this.abort) throw "Aborted";
            this.setColor([i, j], 'swap');
            this.log(`äº¤æ¢ [${i}](${this.array[i]}) â†” [${j}](${this.array[j]})`, 'swap');
            await this.sleep();

            let temp = this.array[i];
            this.array[i] = this.array[j];
            this.array[j] = temp;

            this.bars[i].style.height = `${this.array[i] * 2.5}px`;
            this.bars[i].querySelector('.bar-val').innerText = this.array[i];
            this.bars[j].style.height = `${this.array[j] * 2.5}px`;
            this.bars[j].querySelector('.bar-val').innerText = this.array[j];

            await this.sleep();
            this.setColor([i, j], 'default');
        }

        async overwrite(idx, newVal) {
            if(this.abort) throw "Aborted";
            this.setColor(idx, 'swap');
            // this.log(`è¦†å†™ [${idx}] = ${newVal}`, 'swap');

            this.array[idx] = newVal;
            this.bars[idx].style.height = `${newVal * 2.5}px`;
            this.bars[idx].querySelector('.bar-val').innerText = newVal;

            await this.sleep();
            this.setColor(idx, 'default');
        }

        updatePointers(pointerMap) {
            const colors = { "i": "#ef4444", "j": "#f59e0b", "min": "#10b981", "pivot": "#8b5cf6", "k": "#3b82f6" };

            // ç®€å•å¤ç”¨/åˆ›å»ºé€»è¾‘
            Object.keys(pointerMap).forEach(key => {
                const idx = pointerMap[key];
                if(idx < 0 || idx >= this.size) return;

                let ptr = document.getElementById(`ptr-${key}`);
                if (!ptr) {
                    ptr = document.createElement('div');
                    ptr.id = `ptr-${key}`;
                    ptr.className = 'pointer';
                    ptr.innerHTML = `
                        <div class="pointer-arrow" style="border-bottom-color: ${colors[key] || '#333'}"></div>
                        <div class="pointer-label" style="color: ${colors[key] || '#333'}">${key}</div>
                    `;
                    this.container.appendChild(ptr);
                }
                const bar = this.bars[idx];
                ptr.style.left = `${bar.offsetLeft}px`;
            });

            document.querySelectorAll('.pointer').forEach(p => {
                const key = p.id.split('-')[1];
                if (pointerMap[key] === undefined) p.remove();
            });
        }

        clearPointers() {
            document.querySelectorAll('.pointer').forEach(p => p.remove());
        }

        // --- ä¸»æ§é€»è¾‘ ---
        async start() {
            if(this.isSorting) return;
            this.isSorting = true;
            this.abort = false;
            document.getElementById('btn-start').disabled = true;

            const algo = document.getElementById('algo-select').value;
            try {
                if (algo === 'bubble') await this.bubbleSort();
                if (algo === 'selection') await this.selectionSort();
                if (algo === 'insertion') await this.insertionSort();
                if (algo === 'quick') await this.quickSort(0, this.size - 1);
                if (algo === 'merge') await this.mergeSort(0, this.size - 1);

                this.log("æ’åºå®Œæˆï¼");
                this.clearPointers();
                this.setColor(this.array.map((_, i) => i), 'sorted');
            } catch (e) {
                if(e === "Aborted") this.log("å·²åœæ­¢");
                else console.error(e);
            }
            this.isSorting = false;
            document.getElementById('btn-start').disabled = false;
        }

        // --- æ’åºç®—æ³•å®ç° (å¸¦å¯è§†åŒ–é’©å­) ---

        async bubbleSort() {
            for (let i = 0; i < this.size - 1; i++) {
                for (let j = 0; j < this.size - i - 1; j++) {
                    this.updatePointers({ "i": i, "j": j });
                    this.setColor([j, j+1], 'compare');
                    if (this.array[j] > this.array[j + 1]) {
                        await this.swap(j, j + 1);
                    } else {
                        await this.sleep();
                    }
                    this.setColor([j, j+1], 'default');
                }
                this.setColor(this.size - 1 - i, 'sorted');
            }
            this.setColor(0, 'sorted');
        }

        async selectionSort() {
            for (let i = 0; i < this.size; i++) {
                let minIdx = i;
                this.updatePointers({ "i": i, "min": minIdx });
                for (let j = i + 1; j < this.size; j++) {
                    this.updatePointers({ "i": i, "min": minIdx, "j": j });
                    this.setColor([j, minIdx], 'compare');
                    await this.sleep();
                    if (this.array[j] < this.array[minIdx]) {
                        this.setColor(minIdx, 'default');
                        minIdx = j;
                        this.setColor(minIdx, 'compare');
                    } else {
                        this.setColor(j, 'default');
                    }
                }
                if (minIdx !== i) await this.swap(i, minIdx);
                this.setColor(i, 'sorted');
            }
        }

        async insertionSort() {
            this.setColor(0, 'sorted');
            for (let i = 1; i < this.size; i++) {
                let j = i;
                this.updatePointers({ "i": i, "j": j });
                while (j > 0 && this.array[j] < this.array[j - 1]) {
                    this.updatePointers({ "i": i, "j": j });
                    this.setColor([j, j-1], 'compare');
                    await this.sleep();
                    await this.swap(j, j - 1);
                    this.setColor([j, j-1], 'sorted');
                    j--;
                }
                for(let k=0; k<=i; k++) this.setColor(k, 'sorted');
            }
        }

        async quickSort(start, end) {
            if (start >= end) {
                if(start >= 0 && start < this.size) this.setColor(start, 'sorted');
                return;
            }
            let pivotIndex = await this.partition(start, end);
            this.setColor(pivotIndex, 'sorted');
            await Promise.all([
                this.quickSort(start, pivotIndex - 1),
                this.quickSort(pivotIndex + 1, end)
            ]);
        }

        async partition(start, end) {
            let pivotValue = this.array[end];
            let pivotIndex = start;
            this.setColor(end, 'pivot');
            for (let i = start; i < end; i++) {
                this.updatePointers({ "pivot": end, "j": i, "i": pivotIndex });
                this.setColor(i, 'compare');
                await this.sleep();
                if (this.array[i] < pivotValue) {
                    await this.swap(i, pivotIndex);
                    this.setColor(pivotIndex, 'aux');
                    pivotIndex++;
                } else {
                    this.setColor(i, 'default');
                }
            }
            await this.swap(pivotIndex, end);
            for(let i=start; i<=end; i++) if(i !== pivotIndex) this.setColor(i, 'default');
            return pivotIndex;
        }

        async mergeSort(start, end) {
            if (start >= end) return;
            const mid = Math.floor((start + end) / 2);
            await this.mergeSort(start, mid);
            await this.mergeSort(mid + 1, end);
            await this.merge(start, mid, end);
        }

        async merge(start, mid, end) {
            for(let i=start; i<=end; i++) this.setColor(i, 'aux');
            let leftArr = this.array.slice(start, mid + 1);
            let rightArr = this.array.slice(mid + 1, end + 1);
            let i = 0, j = 0, k = start;
            while (i < leftArr.length && j < rightArr.length) {
                this.updatePointers({ "k": k });
                if (leftArr[i] <= rightArr[j]) {
                    await this.overwrite(k, leftArr[i]);
                    i++;
                } else {
                    await this.overwrite(k, rightArr[j]);
                    j++;
                }
                k++;
            }
            while (i < leftArr.length) {
                this.updatePointers({ "k": k });
                await this.overwrite(k, leftArr[i]);
                i++; k++;
            }
            while (j < rightArr.length) {
                this.updatePointers({ "k": k });
                await this.overwrite(k, rightArr[j]);
                j++; k++;
            }
            for(let x=start; x<=end; x++) this.setColor(x, 'sorted');
        }
    }

    const visualizer = new SortVisualizer();
    document.getElementById('global-back-btn').addEventListener('click', () => {
        // é€»è¾‘ï¼šå¦‚æœæ˜¯è¢«çˆ¶çª—å£æ‰“å¼€çš„ï¼ˆBlob URLæ¨¡å¼ï¼‰ï¼Œåˆ™å…³é—­è‡ªå·±
        if (window.opener) {
            window.close();
        }
        // é€»è¾‘ï¼šå¦‚æœæ˜¯ç›´æ¥æ‰“å¼€æ–‡ä»¶çš„ï¼Œåˆ™å°è¯•å›é€€æˆ–è·³è½¬
        else {
            if (document.referrer) {
                window.history.back();
            } else {
                // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼ˆç›´æ¥åŒå‡»æ‰“å¼€ï¼‰ï¼Œå°è¯•è·³è½¬åˆ°åŒçº§ç›®å½•ä¸‹çš„ index.html
                window.location.href = './index.html'; // å‡è®¾ index.html åœ¨åŒçº§
                // æˆ–è€…å°è¯•è·³åˆ°ä¸Šä¸€çº§
                // window.location.href = '../index.html';
            }
        }
    });

    // é¼ æ ‡æ‚¬åœæ•ˆæœ
    const btn = document.getElementById('global-back-btn');
    btn.onmouseover = () => { btn.style.transform = 'translateY(-2px)'; btn.style.boxShadow = '0 6px 16px rgba(0,0,0,0.2)'; };
    btn.onmouseout = () => { btn.style.transform = 'none'; btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)'; };
</script>
</body>
</html>
