<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¿«é€Ÿæ’åº (QuickSort) æ·±åº¦å¯è§†åŒ–</title>
    <style>
        body{font-family:'Segoe UI',sans-serif;padding:20px;text-align:center;background:#f8fafc;color:#333;display:flex;flex-direction:column;align-items:center;}
        .container{background:white;padding:30px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:inline-block;max-width:1100px;width:95%;}
        
        /* é¡¶éƒ¨æ§åˆ¶ */
        .controls-top { margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; }
        .controls-playback { margin-top: 15px; display: flex; gap: 10px; justify-content: center; align-items: center; background: #f1f5f9; padding: 10px; border-radius: 8px;}
        
        input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; width: 60px; text-align: center; }
        input.arr-input { width: 300px; text-align: left; }
        
        button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; transition: 0.2s; font-weight: 600; display: flex; align-items: center; gap: 5px;}
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-control { background: #ffffff; border: 1px solid #cbd5e1; color: #334155; min-width: 40px; justify-content: center; font-size: 18px;}
        .btn-control:hover { background: #e2e8f0; }
        
        /* è¿›åº¦æ¡ */
        #progressBar { width: 300px; cursor: pointer; accent-color: #3b82f6; }

        /* å¯è§†åŒ–åŒºåŸŸ */
        .visualization-area {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            min-height: 220px;
            margin: 20px 0;
            overflow-x: auto;
            padding-top: 60px; /* ä¸Šæ–¹ç•™ç™½ç»™æŒ‡é’ˆ */
            padding-bottom: 40px;
        }

        .node-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 6px;
            position: relative;
            transition: all 0.2s;
        }

        .node {
            width: 50px;
            height: 50px;
            border: 2px solid #334155;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            z-index: 2;
            transition: background-color 0.2s, transform 0.2s;
        }

        .index-label { margin-top: 5px; font-size: 12px; color: #64748b; font-family: monospace; }

        /* çŠ¶æ€é¢œè‰² */
        .bg-inactive { background-color: #f1f5f9; color: #cbd5e1; border-color: #e2e8f0; } /* ä¸åœ¨å½“å‰é€’å½’èŒƒå›´ */
        .bg-active { background-color: #ffffff; border-color: #334155; } /* å½“å‰èŒƒå›´ */
        .bg-pivot { background-color: #facc15 !important; border-color: #ca8a04; } /* åŸºå‡†å€¼ */
        .bg-compare { background-color: #bfdbfe; transform: scale(1.1); } /* æ¯”è¾ƒä¸­ */
        .bg-swapping { background-color: #fda4af; transform: scale(1.15); border-color: #e11d48; z-index: 10;} /* äº¤æ¢ä¸­ */
        .bg-check { background-color: #d8b4fe; transform: scale(1.05); } /* ä¼˜åŒ–æ£€æŸ¥ä¸­ */
        .bg-sorted-final { background-color: #22c55e !important; color: white; border-color: #15803d; box-shadow: 0 0 10px #86efac; } /* æœ€ç»ˆæœ‰åº */

        /* æŒ‡é’ˆæ ·å¼ */
        .pointer {
            position: absolute;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            padding: 2px 5px;
            border-radius: 4px;
            transition: top 0.2s, left 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .ptr-i { top: -35px; background: #ef4444; color: white; z-index: 5; }
        .ptr-j { top: -35px; background: #3b82f6; color: white; z-index: 5; }
        .ptr-pivot { bottom: -35px; background: #facc15; color: #854d0e; border: 1px solid #ca8a04; font-weight: 800; }
        .ptr-range { bottom: -60px; color: #64748b; font-size: 10px; border: 1px dashed #94a3b8; background: #f8fafc; padding: 2px 8px;}

        /* æ—¥å¿— */
        .log-panel {
            width: 100%;
            height: 100px;
            overflow-y: auto;
            background: #1e293b;
            color: #4ade80;
            font-family: 'Consolas', monospace;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            text-align: left;
            margin-top: 10px;
            box-sizing: border-box;
            white-space: pre-wrap;
            border: 1px solid #334155;
        }

        .legend {
            font-size: 12px; color: #64748b; margin-bottom: 5px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;
        }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .box { width: 12px; height: 12px; border-radius: 2px; border: 1px solid #ccc;}
    </style>
</head>
<body>

    <div id="global-back-btn" style="position:fixed;top:15px;left:15px;z-index:9999;cursor:pointer;background:white;padding:8px 12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:flex;align-items:center;gap:6px;border:1px solid #e2e8f0;transition:all 0.2s;user-select:none;">
        <span style="font-size:16px;">ğŸ”™</span><span style="font-weight:600;font-size:14px;color:#334155;">è¿”å›ç›®å½•</span>
    </div>
    <script>
        document.getElementById('global-back-btn').addEventListener('click', () => {
            if(window.opener) window.close();
            else window.history.back();
        });
        const btn = document.getElementById('global-back-btn');
        btn.onmouseover = () => { btn.style.transform='translateY(-2px)'; btn.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'; };
        btn.onmouseout = () => { btn.style.transform='none'; btn.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'; };
    </script>

    <div class="container">
        <h1>å¿«é€Ÿæ’åº (QuickSort) å¯è§†åŒ–</h1>
        
        <div class="controls-top">
            <label>åˆå§‹æ•°ç»„: <input type="text" id="arrInput" class="arr-input" value="5,1,1,2,0,0"></label>
            <button class="btn-primary" onclick="initAndRun()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="box" style="background:#facc15"></div>Pivot(åŸºå‡†)</div>
            <div class="legend-item"><div class="box" style="background:#ef4444"></div>æŒ‡é’ˆ i</div>
            <div class="legend-item"><div class="box" style="background:#3b82f6"></div>æŒ‡é’ˆ j</div>
            <div class="legend-item"><div class="box" style="background:#d8b4fe"></div>æœ‰åºæ€§æ£€æŸ¥</div>
            <div class="legend-item"><div class="box" style="background:#22c55e"></div>å·²æ’åº</div>
            <div class="legend-item"><div class="box" style="background:#f1f5f9; border-color:#e2e8f0"></div>éå½“å‰åŒºé—´</div>
        </div>

        <div class="visualization-area" id="visArea"></div>

        <div class="controls-playback">
            <button class="btn-control" onclick="step(-1)" title="ä¸Šä¸€æ­¥">â®</button>
            <button class="btn-control" id="btnPlay" onclick="togglePlay()" title="æ’­æ”¾/æš‚åœ">â¯</button>
            <button class="btn-control" onclick="step(1)" title="ä¸‹ä¸€æ­¥">â­</button>
            
            <input type="range" id="progressBar" value="0" min="0" max="0" step="1" oninput="scrub(this.value)">
            <span id="stepCounter" style="font-family:monospace; min-width: 60px;">0 / 0</span>
            
            <label style="font-size: 12px; margin-left: 10px;">é€Ÿåº¦: 
                <select id="speedSelect">
                    <option value="1200">å¾ˆæ…¢</option>
                    <option value="600" selected>æ­£å¸¸</option>
                    <option value="200">å¿«</option>
                    <option value="50">æé€Ÿ</option>
                </select>
            </label>
        </div>
        
        <div class="log-panel" id="logPanel">ç‚¹å‡»â€œé‡æ–°ç”Ÿæˆâ€å¼€å§‹...</div>
    </div>

<script>
    // --- å…¨å±€å˜é‡ ---
    let frames = [];         // å­˜å‚¨åŠ¨ç”»å¸§
    let currentFrameIndex = 0;
    let timer = null;        // è‡ªåŠ¨æ’­æ”¾å®šæ—¶å™¨
    let isPlaying = false;
    
    // --- ç®—æ³•æ¨¡æ‹Ÿä¸å¸§ç”Ÿæˆ ---

    function generateFrames(initialNums) {
        const history = [];
        const nums = [...initialNums];
        // è®°å½•å“ªäº›ä½ç½®å·²ç»æ˜¯æœ€ç»ˆæœ‰åºçš„
        const sortedMap = new Array(nums.length).fill(false);

        // è¾…åŠ©ï¼šåˆ›å»ºå¿«ç…§
        // type: 'normal'|'check'|'swap'|'pivot'|'done'
        const snapshot = (msg, ptrs = {}, type = 'normal', activeIndices = []) => {
            history.push({
                arr: [...nums],
                sorted: [...sortedMap],
                ptrs: { left: -1, right: -1, i: -1, j: -1, pivot: -1, ...ptrs }, // é»˜è®¤-1ä¸æ˜¾ç¤º
                msg: msg,
                type: type,
                activeIndices: activeIndices
            });
        };

        // é€’å½’å‡½æ•°
        const quickSort = (left, right) => {
            // åŸºç¡€è¾¹ç•Œæ£€æŸ¥
            if (left >= right) {
                if (left >= 0 && left < nums.length) sortedMap[left] = true; 
                return;
            }

            snapshot(`é€’å½’å¤„ç†åŒºé—´ [${left}, ${right}]`, { left, right });

            // 1. ä¼˜åŒ–ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»æœ‰åº
            let ordered = true;
            for (let k = left; k < right; k++) {
                snapshot(`æ£€æŸ¥æ˜¯å¦æœ‰åº: æ¯”è¾ƒ nums[${k}] å’Œ nums[${k+1}]`, { left, right, i: k }, 'check', [k, k+1]);
                if (nums[k] > nums[k+1]) {
                    ordered = false;
                    snapshot(`å‘ç°é™åºå¯¹: ${nums[k]} > ${nums[k+1]}ï¼Œæ•°ç»„æœªæ’åºï¼Œéœ€è¦åˆ’åˆ†`, { left, right, i: k }, 'normal', [k, k+1]);
                    break;
                }
            }

            if (ordered) {
                snapshot(`åŒºé—´ [${left}, ${right}] å·²ç»æ˜¯å‡åºï¼Œç›´æ¥è·³è¿‡ï¼(ä¼˜åŒ–)`, { left, right }, 'done', []);
                // æ ‡è®°è¯¥åŒºé—´ä¸ºå·²æ’åº
                for(let k = left; k <= right; k++) sortedMap[k] = true;
                return;
            }

            // 2. åˆ’åˆ†
            let pIndex = partition(left, right);
            
            // æ ‡è®° Pivot æœ€ç»ˆä½ç½®
            sortedMap[pIndex] = true;
            snapshot(`Pivot å½’ä½å®Œæˆï¼Œä¸‹æ ‡ ${pIndex} ç¡®ç«‹`, { left, right, pivot: pIndex }, 'done', [pIndex]);

            // é€’å½’
            quickSort(left, pIndex - 1);
            quickSort(pIndex + 1, right);
        };

        // åˆ’åˆ†å‡½æ•°
        const partition = (left, right) => {
            // éšæœºé€‰æ‹© pivot
            let randIdx = left + Math.floor(Math.random() * (right - left + 1));
            let pivot = nums[randIdx];
            
            snapshot(`éšæœºé€‰æ‹© Pivot: nums[${randIdx}] = ${pivot}`, { left, right, pivot: randIdx }, 'pivot', [randIdx]);

            // äº¤æ¢åˆ°å·¦è¾¹
            snapshot(`å°† Pivot äº¤æ¢åˆ°å·¦è¾¹ç•Œ ${left} æš‚å­˜`, { left, right, pivot: randIdx }, 'swap', [randIdx, left]);
            swap(nums, randIdx, left);
            
            // åŒæŒ‡é’ˆ
            let i = left + 1;
            let j = right;
            let pPos = left; // æ­¤æ—¶ pivot åœ¨ left

            snapshot(`åˆå§‹åŒ–åŒæŒ‡é’ˆ i=${i}, j=${j}`, { left, right, i, j, pivot: pPos });

            while (true) {
                // i å¯»æ‰¾ >= pivot
                while (i <= j) {
                    snapshot(`i=${i}: nums[i]=${nums[i]} < pivot(${pivot}) ?`, { left, right, i, j, pivot: pPos }, 'check', [i]);
                    if (nums[i] < pivot) {
                        i++;
                    } else {
                        snapshot(`nums[i]=${nums[i]} >= pivotï¼Œi åœæ­¢`, { left, right, i, j, pivot: pPos });
                        break;
                    }
                }

                // j å¯»æ‰¾ <= pivot
                while (i <= j) {
                    snapshot(`j=${j}: nums[j]=${nums[j]} > pivot(${pivot}) ?`, { left, right, i, j, pivot: pPos }, 'check', [j]);
                    if (nums[j] > pivot) {
                        j--;
                    } else {
                        snapshot(`nums[j]=${nums[j]} <= pivotï¼Œj åœæ­¢`, { left, right, i, j, pivot: pPos });
                        break;
                    }
                }

                if (i >= j) {
                    snapshot(`æŒ‡é’ˆç›¸é‡ (i >= j)ï¼Œæ‰«æç»“æŸ`, { left, right, i, j, pivot: pPos });
                    break;
                }

                // äº¤æ¢
                snapshot(`äº¤æ¢ nums[${i}](${nums[i]}) å’Œ nums[${j}](${nums[j]})`, { left, right, i, j, pivot: pPos }, 'swap', [i, j]);
                swap(nums, i, j);
                i++;
                j--;
                snapshot(`äº¤æ¢å®Œæˆï¼Œi, j ç»§ç»­é æ‹¢`, { left, right, i, j, pivot: pPos });
            }

            // Pivot å½’ä½
            snapshot(`Pivot å½’ä½: äº¤æ¢ nums[${left}] å’Œ nums[${j}]`, { left, right, i, j, pivot: pPos }, 'swap', [left, j]);
            swap(nums, left, j);
            
            return j;
        };

        const swap = (arr, a, b) => {
            let tmp = arr[a]; arr[a] = arr[b]; arr[b] = tmp;
        };

        // å¼€å§‹
        snapshot("ç®—æ³•å¼€å§‹", {});
        quickSort(0, nums.length - 1);
        snapshot("æ’åºå®Œæˆ", {}, 'done');

        return history;
    }

    // --- æ¸²æŸ“å¼•æ“ ---

    function initAndRun() {
        stopAutoPlay();
        
        const arrStr = document.getElementById('arrInput').value;
        const nums = arrStr.split(',').map(x => {
            const parsed = parseInt(x.trim());
            return isNaN(parsed) ? 0 : parsed;
        });

        // 1. é¢„è®¡ç®—æ‰€æœ‰å¸§
        frames = generateFrames(nums);
        
        // 2. é‡ç½® UI
        document.getElementById('progressBar').max = frames.length - 1;
        document.getElementById('progressBar').value = 0;
        
        currentFrameIndex = 0;
        renderFrame(0);
        
        document.getElementById('btnPlay').innerHTML = "â¯";
    }

    function renderFrame(index) {
        if (index < 0 || index >= frames.length) return;

        const frame = frames[index];
        const { arr, sorted, ptrs, msg, type, activeIndices } = frame;

        // æ›´æ–°æ—¥å¿—
        document.getElementById('logPanel').innerText = `[Step ${index + 1}/${frames.length}] ${msg}`;
        document.getElementById('stepCounter').innerText = `${index + 1}/${frames.length}`;
        document.getElementById('progressBar').value = index;

        // æ¸²æŸ“ DOM
        const area = document.getElementById('visArea');
        area.innerHTML = '';

        arr.forEach((val, idx) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'node-wrapper';

            const node = document.createElement('div');
            node.className = 'node';
            node.innerText = val;

            // 1. åŸºç¡€çŠ¶æ€ï¼šæ˜¯å¦åœ¨å½“å‰é€’å½’åŒºé—´å†…
            const isInRange = (ptrs.left !== -1 && ptrs.right !== -1 && idx >= ptrs.left && idx <= ptrs.right);
            
            if (!isInRange && ptrs.left !== -1) { // -1 è¡¨ç¤ºåˆå§‹çŠ¶æ€æˆ–å…¨èŒƒå›´
                node.classList.add('bg-inactive');
            }

            // 2. å·²æ’åºçŠ¶æ€ (Green)
            if (sorted[idx]) {
                node.classList.add('bg-sorted-final');
            }

            // 3. åŠ¨æ€é«˜äº® (Check/Swap/Pivot)
            if (activeIndices && activeIndices.includes(idx)) {
                if (type === 'swap') node.classList.add('bg-swapping');
                else if (type === 'check') node.classList.add('bg-check');
                else if (type === 'pivot') node.classList.add('bg-pivot');
            }
            
            // Pivot ä½ç½®å¸¸äº® (å¦‚æœä¸æ˜¯ Swap çŠ¶æ€)
            if (ptrs.pivot === idx && type !== 'swap' && !sorted[idx]) {
                node.classList.add('bg-pivot');
            }

            // æŒ‡é’ˆ DOM
            const ptrContainer = document.createDocumentFragment();
            
            if (ptrs.i === idx) addPointer(ptrContainer, 'i', 'ptr-i');
            if (ptrs.j === idx) addPointer(ptrContainer, 'j', 'ptr-j');
            if (ptrs.pivot === idx && ptrs.pivot !== ptrs.left) addPointer(ptrContainer, 'Pivot', 'ptr-pivot'); // å·²ç»åœ¨leftæ—¶ä¸éœ€è¦é¢å¤–æ˜¾ç¤º
            
            // åŒºé—´è¾¹ç•Œ L / R
            if (ptrs.left === idx) addPointer(ptrContainer, 'L', 'ptr-range');
            if (ptrs.right === idx) addPointer(ptrContainer, 'R', 'ptr-range');

            wrapper.appendChild(ptrContainer);
            wrapper.appendChild(node);
            
            const label = document.createElement('div');
            label.className = 'index-label';
            label.innerText = idx;
            wrapper.appendChild(label);

            area.appendChild(wrapper);
        });
    }

    function addPointer(parent, text, className) {
        const p = document.createElement('div');
        p.className = `pointer ${className}`;
        p.innerText = text;
        parent.appendChild(p);
    }

    // --- æ§åˆ¶é€»è¾‘ ---

    function step(delta) {
        const newIndex = currentFrameIndex + delta;
        if (newIndex >= 0 && newIndex < frames.length) {
            currentFrameIndex = newIndex;
            renderFrame(currentFrameIndex);
        } else {
            if (isPlaying && delta > 0) stopAutoPlay();
        }
    }

    function scrub(val) {
        stopAutoPlay();
        currentFrameIndex = parseInt(val);
        renderFrame(currentFrameIndex);
    }

    function togglePlay() {
        if (isPlaying) stopAutoPlay();
        else startAutoPlay();
    }

    function startAutoPlay() {
        if (currentFrameIndex >= frames.length - 1) currentFrameIndex = -1;
        isPlaying = true;
        document.getElementById('btnPlay').innerHTML = "â¸";
        
        const speed = parseInt(document.getElementById('speedSelect').value);
        
        // ç«‹å³æ‰§è¡Œä¸€æ­¥
        step(1);
        timer = setInterval(() => {
            step(1);
        }, speed);
    }

    function stopAutoPlay() {
        isPlaying = false;
        document.getElementById('btnPlay').innerHTML = "â¯";
        clearInterval(timer);
    }

    // åˆå§‹åŒ–
    window.onload = initAndRun;

</script>
</body>
</html>