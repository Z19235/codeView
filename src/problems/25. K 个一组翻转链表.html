<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeetCode 25: Kä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨å¯è§†åŒ–</title>
    <style>
        :root {
            --node-size: 60px;
            --bg-color: #f0f2f5;
            --primary-color: #1890ff;
            --danger-color: #ff4d4f;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --purple-color: #722ed1;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        h2 { color: #333; }
        #canvas-container {
            position: relative;
            width: 900px;
            height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 20px 0;
            overflow: hidden; /* Hide overflow for arrows */
        }

        /* Node Styles */
        .node {
            position: absolute;
            width: var(--node-size);
            height: var(--node-size);
            background: white;
            border: 3px solid #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            z-index: 2;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .node.highlight-group { background-color: #e6f7ff; border-color: var(--primary-color); }
        .node.highlight-reversing { background-color: #fff1f0; border-color: var(--danger-color); }

        /* SVG Arrows */
        #svg-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        .arrow-line {
            stroke: #999; stroke-width: 3; fill: none;
            transition: all 0.3s ease;
        }
        .arrow-line.changing { stroke: var(--danger-color); stroke-width: 4; }

        /* Pointer Labels */
        .label-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 3;
            transition: all 0.3s ease;
        }
        .label-tag {
            font-size: 12px; color: white; padding: 4px 8px;
            border-radius: 4px; margin-bottom: 2px; white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-family: monospace;
        }
        /* Label Color Coding */
        .lbl-head { background-color: var(--danger-color); }
        .lbl-start { background-color: var(--primary-color); }
        .lbl-end { background-color: var(--primary-color); }
        .lbl-preLast { background-color: var(--purple-color); }
        /* Reverse internal pointers */
        .lbl-cur { background-color: var(--success-color); }
        .lbl-pre { background-color: #8c8c8c; }
        .lbl-next { background-color: var(--warning-color); }

        /* Controls and Explanation */
        #control-panel {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        button {
            padding: 10px 20px; font-size: 16px; cursor: pointer;
            background-color: var(--primary-color); color: white;
            border: none; border-radius: 6px; transition: background 0.2s;
        }
        button:hover { background-color: #40a9ff; }
        button:disabled { background-color: #d9d9d9; cursor: not-allowed; }

        #explanation-box {
            width: 900px;
            min-height: 80px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary-color);
        }
        #step-code { font-family: monospace; font-weight: bold; color: #333; margin-bottom: 8px; display: block;}
        #step-desc { color: #555; }
    </style>
</head>
<body>
<div id="global-back-btn" style="position: fixed; top: 15px; left: 15px; z-index: 9999; cursor: pointer; background: white; padding: 8px 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 6px; font-family: 'Segoe UI', sans-serif; border: 1px solid #e2e8f0; transition: all 0.2s; user-select: none;">
    <span style="font-size: 16px;">ğŸ”™</span>
    <span style="font-weight: 600; font-size: 14px; color: #334155;">è¿”å›ç›®å½•</span>
</div>
<h2>Kä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨ (Demo: èŠ‚ç‚¹ 1-8, K=3)</h2>

<div id="canvas-container">
    <svg id="svg-layer">
        <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#999" />
            </marker>
            <marker id="arrowhead-changing" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#ff4d4f" />
            </marker>
        </defs>
    </svg>
    <div id="nodes-layer">
    </div>
    <div id="labels-layer">
    </div>
</div>

<div id="control-panel">
    <button onclick="resetDemo()">é‡ç½® (Reset)</button>
    <button id="nextBtn" onclick="nextStep()">ä¸‹ä¸€æ­¥ (Next Step)</button>
</div>

<div id="explanation-box">
    <span id="step-code">// å‡†å¤‡å¼€å§‹...</span>
    <span id="step-desc">ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€å¼€å§‹æ‰§è¡Œç®—æ³•æ¼”ç¤ºã€‚</span>
</div>

<script>
    // ===========================
    // 1. æ•°æ®ç»“æ„ä¸åˆå§‹åŒ–å®šä¹‰
    // ===========================

    // å®šä¹‰ç”¨äºå¯è§†åŒ–çš„é“¾è¡¨èŠ‚ç‚¹æ•°æ®ç»“æ„
    let nodesData = [];
    // å®šä¹‰æŒ‡é’ˆæ ‡ç­¾çš„çŠ¶æ€ (å­˜å‚¨æŒ‡å‘çš„èŠ‚ç‚¹ ID)
    let pointerLabels = {
        head: null, start: null, end: null, preLast: null,
        cur: null, pre: null, next: null // ç”¨äº reverse å‡½æ•°å†…éƒ¨
    };

    // åˆå§‹åŒ–åœºæ™¯ï¼šåˆ›å»º 8 ä¸ªèŠ‚ç‚¹çš„é“¾è¡¨
    function initData() {
        nodesData = [
            { id: 1, val: 1, nextId: 2, x: 100, y: 200 },
            { id: 2, val: 2, nextId: 3, x: 200, y: 200 },
            { id: 3, val: 3, nextId: 4, x: 300, y: 200 },
            { id: 4, val: 4, nextId: 5, x: 400, y: 200 },
            { id: 5, val: 5, nextId: 6, x: 500, y: 200 },
            { id: 6, val: 6, nextId: 7, x: 600, y: 200 },
            { id: 7, val: 7, nextId: 8, x: 700, y: 200 },
            { id: 8, val: 8, nextId: null, x: 800, y: 200 }
        ];
        pointerLabels = { head: 1, start: null, end: null, preLast: null, cur: null, pre: null, next: null };
        clearHighlights();
    }

    // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®èŠ‚ç‚¹çš„ next æŒ‡é’ˆ
    function setNext(nodeId, nextNodeId) {
        const node = nodesData.find(n => n.id === nodeId);
        if (node) node.nextId = nextNodeId;
    }

    // è¾…åŠ©å‡½æ•°ï¼šé«˜äº®/å–æ¶ˆé«˜äº®èŠ‚ç‚¹
    function highlightNodes(ids, type) {
        clearHighlights();
        ids.forEach(id => {
            const el = document.getElementById(`node-${id}`);
            if (el) el.classList.add(type);
        });
    }
    function clearHighlights() {
        document.querySelectorAll('.node').forEach(el => {
            el.classList.remove('highlight-group', 'highlight-reversing');
        });
    }

    // ===========================
    // 2. è§†å›¾æ¸²æŸ“é€»è¾‘ (View)
    // ===========================

    function renderScene(changingSourceId = null) {
        renderNodes();
        renderArrows(changingSourceId);
        renderLabels();
    }

    function renderNodes() {
        const container = document.getElementById('nodes-layer');
        if (container.children.length === 0) {
            nodesData.forEach(n => {
                const el = document.createElement('div');
                el.id = `node-${n.id}`;
                el.className = 'node';
                el.innerText = n.val;
                el.style.left = `${n.x - 30}px`;
                el.style.top = `${n.y - 30}px`;
                container.appendChild(el);
            });
        }
    }

    function renderArrows(changingSourceId) {
        const svg = document.getElementById('svg-layer');
        // åªç§»é™¤çº¿æ¡ï¼Œä¿ç•™ defs
        const lines = svg.querySelectorAll('.arrow-line');
        lines.forEach(line => line.remove());

        nodesData.forEach(sourceNode => {
            if (sourceNode.nextId !== null) {
                const targetNode = nodesData.find(n => n.id === sourceNode.nextId);
                if (targetNode) {
                    drawArrow(svg, sourceNode, targetNode, sourceNode.id === changingSourceId);
                }
            }
        });
    }

    function drawArrow(svg, source, target, isChanging) {
        const path = document.createElementNS("http://www.w3.org/2000/svg", 'path');
        const deltaX = target.x - source.x;
        const deltaY = target.y - source.y;
        const dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
        // è®¡ç®—ç¨å¾®çŸ­ä¸€ç‚¹çš„ç»ˆç‚¹ï¼Œé¿å…ç®­å¤´è¢«èŠ‚ç‚¹é®æŒ¡
        const endX = target.x - (deltaX / dist) * 32;
        const endY = target.y - (deltaY / dist) * 32;

        // ä½¿ç”¨è´å¡å°”æ›²çº¿å¢åŠ ä¸€ç‚¹å¼§åº¦ï¼Œä½¿å¾—åå‘è¿æ¥æ›´æ¸…æ™°
        const midX = (source.x + target.x) / 2;
        const midY = (source.y + target.y) / 2;
        // å¦‚æœæ˜¯åå‘æŒ‡ï¼ˆç›®æ ‡åœ¨æºçš„å·¦ä¾§ï¼‰ï¼Œå¢åŠ è¾ƒå¤§çš„å¼§åº¦
        const curveOffset = (target.x < source.x) ? 60 : (Math.abs(target.x - source.x) > 150 ? -30 : 0);

        const d = `M ${source.x} ${source.y} Q ${midX} ${midY + curveOffset} ${endX} ${endY}`;

        path.setAttribute("d", d);
        path.classList.add('arrow-line');
        if (isMouseOver || isChanging) {
            path.setAttribute("marker-end", "url(#arrowhead-changing)");
            path.classList.add('changing');
        } else {
            path.setAttribute("marker-end", "url(#arrowhead)");
        }
        svg.appendChild(path);
    }

    function renderLabels() {
        const layer = document.getElementById('labels-layer');
        layer.innerHTML = '';

        // æŒ‰èŠ‚ç‚¹ ID åˆ†ç»„æ ‡ç­¾
        const labelsByNode = {};
        for (let [key, val] of Object.entries(pointerLabels)) {
            if (val !== null) {
                if (!labelsByNode[val]) labelsByNode[val] = [];
                labelsByNode[val].push(key);
            }
        }

        for (let [nodeId, labels] of Object.entries(labelsByNode)) {
            const node = nodesData.find(n => n.id == nodeId);
            if (node) {
                const container = document.createElement('div');
                container.className = 'label-container';
                // æ ‡ç­¾æ˜¾ç¤ºåœ¨èŠ‚ç‚¹ä¸Šæ–¹
                container.style.left = `${node.x}px`;
                container.style.top = `${node.y - 45 - (labels.length * 22)}px`;
                container.style.transform = 'translateX(-50%)';

                // æ’åºæ ‡ç­¾ï¼Œä¿æŒæ˜¾ç¤ºé¡ºåºä¸€è‡´æ€§ (ä¾‹å¦‚ head æ€»åœ¨æœ€ä¸Šé¢)
                const order = ['head', 'preLast', 'start', 'end', 'next', 'cur', 'pre'];
                labels.sort((a,b) => order.indexOf(a) - order.indexOf(b));

                labels.forEach(lblKey => {
                    const tag = document.createElement('div');
                    tag.className = `label-tag lbl-${lblKey}`;
                    tag.innerText = lblKey;
                    container.appendChild(tag);
                });
                layer.appendChild(container);
            }
        }
    }

    // ===========================
    // 3. ç®—æ³•æ­¥éª¤å®šä¹‰ (The Core Logic Visualization)
    // ===========================
    let currentStepIndex = 0;
    let steps = [];

    function defineSteps() {
        steps = [
            // --- ç¬¬ä¸€ç»„å‡†å¤‡ ---
            {
                code: 'ListNode start = head;',
                desc: 'åˆå§‹åŒ– start æŒ‡é’ˆæŒ‡å‘ headã€‚',
                action: () => { pointerLabels.start = 1; }
            },
            {
                code: 'ListNode end = checkValiable(start, k);',
                desc: 'æ£€æŸ¥ä» start å¼€å§‹æ˜¯å¦æœ‰ K=3 ä¸ªèŠ‚ç‚¹ã€‚æ‰¾åˆ°ç¬¬ 3 ä¸ªèŠ‚ç‚¹ä½œä¸º endã€‚',
                action: () => { pointerLabels.end = 3; highlightNodes([1,2,3], 'highlight-group'); }
            },
            {
                code: 'if(end == null) ... head = end;',
                desc: 'end ä¸ä¸ºç©ºã€‚å°†å…¨å±€ head æ›´æ–°ä¸º end (èŠ‚ç‚¹ 3)ï¼Œè¿™æ˜¯ç¿»è½¬åçš„æ–°å¤´ã€‚',
                action: () => { pointerLabels.head = 3; }
            },
            // === å¼€å§‹ reverse(start:1, end:3) ===
            {
                code: 'reverse(start, end) -> e = e.next;',
                desc: 'è¿›å…¥ reverse å‡½æ•°ã€‚é¦–å…ˆå°† e æŒ‡é’ˆåç§»ä¸€ä½ (å˜ä¸º 4)ï¼Œä½œä¸ºå¾ªç¯ç»ˆæ­¢è¾¹ç•Œã€‚',
                action: () => { pointerLabels.end = 4; highlightNodes([1,2,3], 'highlight-reversing'); }
            },
            {
                code: 'ListNode pre = null, cur = s, next = null;',
                desc: 'åˆå§‹åŒ–ç¿»è½¬æ‰€éœ€çš„è¾…åŠ©æŒ‡é’ˆï¼špre, cur (æŒ‡å‘start), nextã€‚',
                action: () => { pointerLabels.pre = null; pointerLabels.cur = 1; pointerLabels.next = null; }
            },
            // --- Reverse å¾ªç¯ 1 (å¤„ç†èŠ‚ç‚¹ 1) ---
            {
                code: 'while (cur != e) { next = cur.next;',
                desc: 'å¾ªç¯å¼€å§‹ (curæ˜¯1, eæ˜¯4)ã€‚è®°å½• next = cur.next (èŠ‚ç‚¹ 2)ã€‚',
                action: () => { pointerLabels.next = 2; }
            },
            {
                code: 'cur.next = pre;',
                desc: 'ã€å…³é”®ã€‘æ”¹å˜æŒ‡å‘ï¼šå°† cur (1) çš„ next æŒ‡å‘ pre (null)ã€‚',
                action: () => { setNext(1, null); },
                highlightChange: 1
            },
            {
                code: 'pre = cur; cur = next;',
                desc: 'æŒ‡é’ˆå‰ç§»ï¼špre å˜ä¸º 1ï¼Œcur å˜ä¸º 2ã€‚',
                action: () => { pointerLabels.pre = 1; pointerLabels.cur = 2; }
            },
            // --- Reverse å¾ªç¯ 2 (å¤„ç†èŠ‚ç‚¹ 2) ---
            {
                code: 'while (cur != e) { next = cur.next;',
                desc: 'å¾ªç¯ç»§ç»­ (curæ˜¯2, eæ˜¯4)ã€‚è®°å½• next = 3ã€‚',
                action: () => { pointerLabels.next = 3; }
            },
            {
                code: 'cur.next = pre;',
                desc: 'ã€å…³é”®ã€‘æ”¹å˜æŒ‡å‘ï¼šå°† cur (2) çš„ next æŒ‡å‘ pre (1)ã€‚å®Œæˆ 2->1ã€‚',
                action: () => { setNext(2, 1); },
                highlightChange: 2
            },
            {
                code: 'pre = cur; cur = next;',
                desc: 'æŒ‡é’ˆå‰ç§»ï¼špre å˜ä¸º 2ï¼Œcur å˜ä¸º 3ã€‚',
                action: () => { pointerLabels.pre = 2; pointerLabels.cur = 3; }
            },
            // --- Reverse å¾ªç¯ 3 (å¤„ç†èŠ‚ç‚¹ 3) ---
            {
                code: 'while (cur != e) { next = cur.next;',
                desc: 'å¾ªç¯ç»§ç»­ (curæ˜¯3, eæ˜¯4)ã€‚è®°å½• next = 4ã€‚',
                action: () => { pointerLabels.next = 4; }
            },
            {
                code: 'cur.next = pre;',
                desc: 'ã€å…³é”®ã€‘æ”¹å˜æŒ‡å‘ï¼šå°† cur (3) çš„ next æŒ‡å‘ pre (2)ã€‚å®Œæˆ 3->2ã€‚',
                action: () => { setNext(3, 2); },
                highlightChange: 3
            },
            {
                code: 'pre = cur; cur = next;',
                desc: 'æŒ‡é’ˆå‰ç§»ï¼špre å˜ä¸º 3ï¼Œcur å˜ä¸º 4ã€‚ç°åœ¨ cur == eï¼Œå¾ªç¯å°†ç»ˆæ­¢ã€‚',
                action: () => { pointerLabels.pre = 3; pointerLabels.cur = 4; }
            },
            // --- Reverse ç»“æŸå¤„ç† ---
            {
                code: '} s.next = e;',
                desc: 'å¾ªç¯ç»“æŸã€‚å°†åŸæ¥çš„å¤´ start (1) è¿æ¥åˆ°è¾¹ç•Œ e (4)ã€‚ç¬¬ä¸€ç»„ç¿»è½¬å®Œæˆã€‚',
                action: () => { setNext(1, 4); pointerLabels.cur=null; pointerLabels.pre=null; pointerLabels.next=null; clearHighlights();},
                highlightChange: 1
            },
            // === å›åˆ°ä¸»å‡½æ•° ===
            {
                code: 'ListNode preLast = start;',
                desc: 'å›åˆ°ä¸»å‡½æ•°ã€‚start (1) ç°åœ¨æ˜¯ç¬¬ä¸€ç»„çš„å°¾éƒ¨ï¼Œè®°å½•ä¸º preLastï¼Œç”¨äºè¿æ¥ä¸‹ä¸€ç»„ã€‚',
                action: () => { pointerLabels.preLast = 1; }
            },
            // --- ç¬¬äºŒç»„å¾ªç¯å¼€å§‹ ---
            {
                code: 'while(preLast.next!=null) { start = preLast.next;',
                desc: 'ä¸»å¾ªç¯æ£€æŸ¥ preLast åé¢è¿˜æœ‰èŠ‚ç‚¹ã€‚ç§»åŠ¨ start åˆ°ä¸‹ä¸€ç»„å¼€å¤´ (èŠ‚ç‚¹ 4)ã€‚',
                action: () => { pointerLabels.start = 4; }
            },
            {
                code: 'end = checkValiable(start, k);',
                desc: 'æ£€æŸ¥ç¬¬äºŒç»„æ˜¯å¦æœ‰ K=3 ä¸ªèŠ‚ç‚¹ã€‚æ‰¾åˆ° end ä¸ºèŠ‚ç‚¹ 6ã€‚',
                action: () => { pointerLabels.end = 6; highlightNodes([4,5,6], 'highlight-group');}
            },
            // === å¼€å§‹ reverse(start:4, end:6) ===
            {
                code: 'reverse(start, end) -> e = e.next;',
                desc: 'å†æ¬¡è°ƒç”¨ reverseã€‚e åç§»å˜ä¸º 7ã€‚',
                action: () => { pointerLabels.end = 7; highlightNodes([4,5,6], 'highlight-reversing'); }
            },
            {
                code: 'åˆå§‹åŒ– reverse æŒ‡é’ˆ...',
                desc: 'åˆå§‹åŒ– pre=null, cur=4, next=nullã€‚',
                action: () => { pointerLabels.pre = null; pointerLabels.cur = 4; pointerLabels.next = null; }
            },
            // ... çœç•¥ç¬¬äºŒç»„å…·ä½“çš„æ¯ä¸€æ­¥å¾ªç¯æ¼”ç¤ºï¼Œç›´æ¥å¿«è¿›åˆ°ç»“æœï¼Œé¿å…æ¼”ç¤ºå¤ªé•¿ ...
            {
                code: 'æ‰§è¡Œ reverse(4, 7) å¾ªç¯è¿‡ç¨‹...',
                desc: 'ï¼ˆå¿«é€Ÿæ¼”ç¤ºï¼‰å†…éƒ¨å¾ªç¯æ‰§è¡Œï¼š4->null, 5->4, 6->5ã€‚cur å˜ä¸º 7ã€‚',
                action: () => {
                    setNext(4, null); setNext(5, 4); setNext(6, 5);
                    pointerLabels.pre=6; pointerLabels.cur=7; pointerLabels.next=7;
                },
                highlightChange: 6 // Highlight last change
            },
            {
                code: '} s.next = e;',
                desc: 'å¾ªç¯ç»“æŸã€‚åŸå¤´ start (4) è¿æ¥åˆ°è¾¹ç•Œ e (7)ã€‚ç¬¬äºŒç»„ç¿»è½¬å®Œæˆã€‚',
                action: () => { setNext(4, 7); pointerLabels.cur=null; pointerLabels.pre=null; pointerLabels.next=null; clearHighlights();},
                highlightChange: 4
            },
            // === å›åˆ°ä¸»å‡½æ•°è¿æ¥ç»„ ===
            {
                code: 'preLast.next = end;',
                desc: 'ã€å…³é”®è¿æ¥ã€‘å°†ä¸Šä¸€ç»„çš„å°¾å·´ preLast (1) è¿æ¥åˆ°å½“å‰ç»„ç¿»è½¬åçš„å¤´ end (æ³¨æ„:è¿™é‡Œä»£ç é€»è¾‘çš„ end å®é™…ä¸Šæ˜¯æŒ‡å‘ 6, è™½ç„¶å¯è§†åŒ–é‡Œ end æŒ‡é’ˆä¸ºäº† reverse è·‘åˆ°äº† 7ï¼Œæˆ‘ä»¬éœ€è¦é€»è¾‘ä¸Šçš„ end å³ preæŒ‡é’ˆ)ã€‚æˆ‘ä»¬å°† 1 æŒ‡å‘ 6ã€‚',
                // åœ¨ä»£ç é€»è¾‘ä¸­ï¼Œreverseè°ƒç”¨åï¼Œend å˜é‡è¿˜æ˜¯æŒ‡å‘ 6 çš„ï¼ˆåœ¨ e=e.next ä¹‹å‰ï¼‰ã€‚
                // è¿™é‡Œçš„å¯è§†åŒ–ä¸ºäº†å±•ç¤ºæ–¹ä¾¿ï¼Œéœ€è¦ç¨å¾®è°ƒæ•´ä¸€ä¸‹è¯´æ˜ã€‚
                // preLast.next åº”è¯¥æŒ‡å‘å½“å‰ç»„æ–°çš„å¤´ï¼Œä¹Ÿå°±æ˜¯ reverse ç»“æŸæ—¶çš„ 'pre' æŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹(6)ã€‚
                action: () => { setNext(1, 6); pointerLabels.end = 6; /*ä¿®æ­£endæ˜¾ç¤º*/ },
                highlightChange: 1
            },
            {
                code: 'preLast = start;',
                desc: 'æ›´æ–° preLastã€‚å½“å‰ç»„åŸæ¥çš„å¤´ start (4) å˜æˆäº†ç°åœ¨çš„å°¾ã€‚',
                action: () => { pointerLabels.preLast = 4; }
            },
            // --- ç¬¬ä¸‰ç»„å¾ªç¯å°è¯• ---
            {
                code: 'while(...) { start = preLast.next;',
                desc: 'ä¸»å¾ªç¯ç»§ç»­ã€‚ç§»åŠ¨ start åˆ°ä¸‹ä¸€ç»„å¼€å¤´ (èŠ‚ç‚¹ 7)ã€‚',
                action: () => { pointerLabels.start = 7; }
            },
            {
                code: 'end = checkValiable(start, k);',
                desc: 'æ£€æŸ¥å‰©ä½™èŠ‚ç‚¹ã€‚åªæœ‰ 7, 8 ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œä¸è¶³ K=3 ä¸ªã€‚checkValiable è¿”å› nullã€‚',
                action: () => { pointerLabels.end = null; highlightNodes([7,8], 'highlight-group'); }
            },
            {
                code: 'if(end==null) { return head; }',
                desc: 'end ä¸º nullï¼Œç›´æ¥è¿”å›å½“å‰çš„ headã€‚å‰©ä½™èŠ‚ç‚¹ä¸ç¿»è½¬ã€‚ç®—æ³•ç»“æŸã€‚',
                action: () => {
                    clearHighlights();
                    // æ¸…ç†ä¸å¿…è¦çš„æŒ‡é’ˆæ˜¾ç¤ºï¼Œåªç•™ç»“æœ
                    pointerLabels.start=null; pointerLabels.preLast=null;
                    document.getElementById('nextBtn').disabled = true;
                    document.getElementById('nextBtn').innerText = "æ¼”ç¤ºç»“æŸ";
                }
            }
        ];
    }

    // ===========================
    // 4. æ§åˆ¶é€»è¾‘ (Controller)
    // ===========================

    function nextStep() {
        if (currentStepIndex < steps.length) {
            const step = steps[currentStepIndex];
            // æ›´æ–°æ–‡å­—è¯´æ˜
            document.getElementById('step-code').innerText = step.code;
            document.getElementById('step-desc').innerText = step.desc;
            // æ‰§è¡ŒåŠ¨ä½œæ›´æ–°æ•°æ®
            step.action();
            // é‡æ–°æ¸²æŸ“è§†å›¾
            renderScene(step.highlightChange || null);
            currentStepIndex++;
        }
    }

    function resetDemo() {
        currentStepIndex = 0;
        initData();
        defineSteps();
        document.getElementById('nodes-layer').innerHTML = ''; // æ¸…ç©ºèŠ‚ç‚¹é‡å»º
        document.getElementById('step-code').innerText = '// å‡†å¤‡å¼€å§‹...';
        document.getElementById('step-desc').innerText = 'ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€å¼€å§‹æ‰§è¡Œç®—æ³•æ¼”ç¤ºã€‚';
        document.getElementById('nextBtn').disabled = false;
        document.getElementById('nextBtn').innerText = "ä¸‹ä¸€æ­¥ (Next Step)";
        renderScene();
    }

    // ç”¨äºç®­å¤´é¼ æ ‡æ‚¬åœæ•ˆæœçš„æ ‡å¿—
    let isMouseOver = false;
    document.getElementById('svg-layer').addEventListener('mouseover', () => { isMouseOver = true; });
    document.getElementById('svg-layer').addEventListener('mouseout', () => { isMouseOver = false; });

    // å¯åŠ¨
    resetDemo();

    document.getElementById('global-back-btn').addEventListener('click', () => {
        // é€»è¾‘ï¼šå¦‚æœæ˜¯è¢«çˆ¶çª—å£æ‰“å¼€çš„ï¼ˆBlob URLæ¨¡å¼ï¼‰ï¼Œåˆ™å…³é—­è‡ªå·±
        if (window.opener) {
            window.close();
        }
        // é€»è¾‘ï¼šå¦‚æœæ˜¯ç›´æ¥æ‰“å¼€æ–‡ä»¶çš„ï¼Œåˆ™å°è¯•å›é€€æˆ–è·³è½¬
        else {
            if (document.referrer) {
                window.history.back();
            } else {
                // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼ˆç›´æ¥åŒå‡»æ‰“å¼€ï¼‰ï¼Œå°è¯•è·³è½¬åˆ°åŒçº§ç›®å½•ä¸‹çš„ index.html
                window.location.href = './index.html'; // å‡è®¾ index.html åœ¨åŒçº§
                // æˆ–è€…å°è¯•è·³åˆ°ä¸Šä¸€çº§
                // window.location.href = '../index.html';
            }
        }
    });

    // é¼ æ ‡æ‚¬åœæ•ˆæœ
    const btn = document.getElementById('global-back-btn');
    btn.onmouseover = () => { btn.style.transform = 'translateY(-2px)'; btn.style.boxShadow = '0 6px 16px rgba(0,0,0,0.2)'; };
    btn.onmouseout = () => { btn.style.transform = 'none'; btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)'; };
</script>
</body>
</html>
